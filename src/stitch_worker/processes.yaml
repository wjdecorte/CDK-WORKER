processes:
  - name: "document-extract"
    enabled: "${lambda_document_extraction}"
    module: "document_extract"
    event_pattern:
      source: ["aws.s3"]
      detail_type: ["Object Created"]
      detail:
        bucket:
          name: ["${s3_bucket_name}"]
    id_prefix: "DocumentExtract"
    additional_policies:
      - effect: "ALLOW"
        actions: ["s3:Get*", "s3:List*", "s3:Put*"]
        resources: ["*"]
      - effect: "ALLOW"
        actions: ["textract:StartDocumentAnalysis"]
        resources: ["*"]
    environment:
      TEXT_EXTRACTION_S3_BUCKET: "${s3_bucket_name}"
      TEXT_EXTRACTION_S3_KEY_PREFIX: "textract-output"
      TEXT_EXTRACTION_SNS_TOPIC_ARN: "${document_extraction_topic_arn}"
      TEXT_EXTRACTION_SNS_ROLE_ARN: "${document_extraction_role_arn}"

  - name: "block-standardization"
    enabled: "${lambda_block_standardization}"
    module: "block_standardization"
    event_pattern:
      source: ["stitch.worker"]
      detail_type: ["DocumentExtractionCompleted"]
    id_prefix: "BlockProcessing"
    additional_policies:
      - effect: "ALLOW"
        actions: ["s3:Get*", "s3:List*", "s3:Put*"]
        resources: ["*"]
    memory_size: 256
    environment:
      BLOCK_SKIP_KEY_VALUE_SET: "False"

  - name: "block-summarization"
    enabled: "${lambda_block_summarization}"
    module: "block_summarization"
    event_pattern:
      source: ["stitch.worker"]
      detail_type: ["BlockStandardizationCompleted"]
    id_prefix: "BlockSummarization"
    additional_policies:
      - effect: "ALLOW"
        actions: ["s3:Get*", "s3:List*", "s3:Put*"]
        resources: ["*"]
    timeout: 600
    memory_size: 512
    environment:
      OPENAI_API_KEY: "${openai_api_key}"
      OPENAI_CHAT_COMPLETION_MODEL: "${openai_chat_completion_model}"

  - name: "block-refinement"
    enabled: "${lambda_block_refinement}"
    module: "block_refinement"
    event_pattern:
      source: ["stitch.worker"]
      detail_type: ["BlockSummarizationCompleted"]
    id_prefix: "BlockRefinement"
    additional_policies:
      - effect: "ALLOW"
        actions: ["s3:Get*", "s3:List*", "s3:Put*"]
        resources: ["*"]
    timeout: 600
    memory_size: 256
    environment:
      OPENAI_API_KEY: "${openai_api_key}"
      PINECONE_API_KEY: "${pinecone_api_key}"
      PINECONE_INDEX_NAME: "${pinecone_index_name}"
      OPENAI_CHAT_COMPLETION_MODEL: "${openai_chat_completion_model}"
      OPENAI_EMBEDDING_MODEL: "${openai_embedding_model}"

  - name: "block-insertion"
    enabled: "${lambda_block_insertion}"
    module: "block_insertion"
    event_pattern:
      source: ["stitch.worker"]
      detail_type: ["BlockRefinementCompleted"]
    id_prefix: "BlockInsertion"
    additional_policies:
      - effect: "ALLOW"
        actions: ["s3:Get*", "s3:List*", "s3:Put*"]
        resources: ["*"]
    environment:
      DATABASE_HOST: "${database_host}"
      DATABASE_PORT: "${database_port}"
      DATABASE_NAME: "${database_name}"
      DATABASE_USER: "${database_user}"
      DATABASE_PASSWORD: "${database_password}"

  - name: "block-cropping"
    enabled: "${lambda_block_cropping}"
    module: "block_cropping"
    event_pattern:
      source: ["stitch.worker"]
      detail_type: ["BlockInsertionCompleted"]
    id_prefix: "BlockCropping"
    additional_policies:
      - effect: "ALLOW"
        actions: ["s3:Get*", "s3:List*", "s3:Put*"]
        resources: ["*"]
    memory_size: 512

  - name: "block-vectorization"
    enabled: "${lambda_block_vectorization}"
    module: "block_vectorization"
    event_pattern:
      source: ["stitch.worker"]
      detail_type: ["BlockInsertionCompleted"]
    id_prefix: "BlockVectorization"
    additional_policies:
      - effect: "ALLOW"
        actions: ["s3:Get*", "s3:List*"]
        resources: ["*"]
    environment:
      EMBEDDING_BATCH_SIZE: "${embedding_batch_size}"
      PINECONE_API_KEY: "${pinecone_api_key}"
      PINECONE_INDEX_NAME: "${pinecone_index_name}"
      OPENAI_API_KEY: "${openai_api_key}"
      OPENAI_EMBEDDING_MODEL: "${openai_embedding_model}"
      OPENAI_CHAT_COMPLETION_MODEL: "${openai_chat_completion_model}"
      CHAT_COMPLETION_TEMPERATURE: "${chat_completion_temperature}"

  - name: "document-summarization"
    enabled: "${lambda_document_summarization}"
    module: "document_summarization"
    event_pattern:
      source: ["stitch.worker"]
      detail_type: ["BlockRefinementCompleted"]
    id_prefix: "DocumentSummarization"
    additional_policies:
      - effect: "ALLOW"
        actions: ["s3:Get*", "s3:List*"]
        resources: ["*"]
    memory_size: 512
    environment:
      OPENAI_API_KEY: "${openai_api_key}"
      OPENAI_CHAT_COMPLETION_MODEL: "${openai_chat_completion_model}"
      DOCUMENT_SUMMARY_MAX_TOKENS: "${document_summary_max_tokens}"

  - name: "seed-question-extraction"
    enabled: "${lambda_seed_question_extraction}"
    module: "seed_question_extraction"
    event_pattern:
      source: ["stitch.worker"]
      detail_type: ["BlockVectorizationCompleted"]
      detail:
        metadata:
          seed_questions: [{"exists": true}]
    id_prefix: "SeedQuestionExtraction"
    additional_policies: []
    environment:
      OPENAI_API_KEY: "${openai_api_key}"
      OPENAI_CHAT_COMPLETION_MODEL: "${openai_chat_completion_model}"
      OPENAI_EMBEDDING_MODEL: "${openai_embedding_model}"
      PINECONE_API_KEY: "${pinecone_api_key}"
      PINECONE_INDEX_NAME: "${pinecone_index_name}"
      DOCUMENT_CONTEXT_SEPARATOR: "${document_context_separator}"
      CHAT_COMPLETION_TEMPERATURE: "${chat_completion_temperature}"

  - name: "feature-extraction"
    enabled: "${lambda_feature_extraction}"
    module: "feature_extraction"
    event_pattern:
      source: ["stitch.worker"]
      detail_type: ["BlockRefinementCompleted"]
      detail:
        metadata:
          feature_types_count: [{"numeric": [">", 0]}]
    id_prefix: "FeatureExtraction"
    additional_policies:
      - effect: "ALLOW"
        actions: ["s3:Get*", "s3:List*"]
        resources: ["*"]
    memory_size: 512
    timeout: 600
    environment:
      OPENAI_API_KEY: "${openai_api_key}"
      OPENAI_CHAT_COMPLETION_MODEL: "${openai_chat_completion_model}"
      OPENAI_EMBEDDING_MODEL: "${openai_embedding_model}"
      PINECONE_API_KEY: "${pinecone_api_key}"
      PINECONE_INDEX_NAME: "${pinecone_index_name}"
      CHAT_COMPLETION_TEMPERATURE: "${chat_completion_temperature}"

  - name: "split-file"
    enabled: "${lambda_split_file}"
    module: "split_file"
    event_pattern:
      source: ["aws.s3"]
      detail_type: ["Object Created"]
      detail:
        bucket:
          name: ["${s3_bucket_name}"]
    id_prefix: "SplitFile"
    additional_policies:
      - effect: "ALLOW"
        actions: ["s3:Get*", "s3:List*", "s3:Put*"]
        resources: ["*"]
    memory_size: 2048
